  "hook": "package com.example.aitranslate\n\nimport android.app.AlertDialog\nimport android.content.Context\nimport android.view.Menu\nimport android.view.MenuItem\nimport android.widget.EditText\nimport android.widget.TextView\nimport android.widget.Toast\nimport de.robv.android.xposed.IXposedHookLoadPackage\nimport de.robv.android.xposed.XC_MethodHook\nimport de.robv.android.xposed.XposedHelpers\nimport de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam\nimport kotlinx.coroutines.*\nimport okhttp3.*\nimport okhttp3.MediaType.Companion.toMediaType\nimport okhttp3.RequestBody.Companion.toRequestBody\nimport org.json.JSONObject\nimport java.util.concurrent.TimeUnit\n\nclass XposedHook : IXposedHookLoadPackage {\n    private val MISTRAL_API_KEY = \"rYYp7sUr8uFom5y6ZZvWCRFdTOFTNgDM\"\n    private val MENU_ID = 991100\n    \n    private val client = OkHttpClient.Builder()\n        .connectTimeout(15, TimeUnit.SECONDS)\n        .build()\n\n    override fun handleLoadPackage(lpparam: LoadPackageParam) {\n        // Хукаем системный класс плавающего меню\n        XposedHelpers.findAndHookMethod(\n            \"com.android.internal.view.FloatingActionMode\",\n            lpparam.classLoader,\n            \"onPrepareActionMode\",\n            \"android.view.ActionMode\",\n            Menu::class.java,\n            object : XC_MethodHook() {\n                override fun afterHookedMethod(param: MethodHookParam) {\n                    val menu = param.args[1] as Menu\n                    if (menu.findItem(MENU_ID) == null) {\n                        menu.add(Menu.NONE, MENU_ID, 100, \"AI Translate\")\n                            .setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM)\n                    }\n                }\n            }\n        )\n\n        // Перехват клика\n        XposedHelpers.findAndHookMethod(\n            \"com.android.internal.view.FloatingActionMode\",\n            lpparam.classLoader,\n            \"onActionItemClicked\",\n            \"android.view.ActionMode\",\n            MenuItem::class.java,\n            object : XC_MethodHook() {\n                override fun beforeHookedMethod(param: MethodHookParam) {\n                    val item = param.args[1] as MenuItem\n                    if (item.itemId == MENU_ID) {\n                        handleTranslateClick(param)\n                        param.result = true\n                    }\n                }\n            }\n        )\n    }\n\n    private fun handleTranslateClick(param: XC_MethodHook.MethodHookParam) {\n        // Получаем View из внутреннего поля FloatingActionMode\n        val mOriginatingView = XposedHelpers.getObjectField(param.thisObject, \"mOriginatingView\") as? TextView ?: return\n        val context = mOriginatingView.context\n        val selectedText = mOriginatingView.text.subSequence(\n            mOriginatingView.selectionStart,\n            mOriginatingView.selectionEnd\n        ).toString()\n\n        if (selectedText.isBlank()) return\n\n        CoroutineScope(Dispatchers.Main).launch {\n            Toast.makeText(context, \"Перевод через AI...\", Toast.LENGTH_SHORT).show()\n            \n            val translation = withContext(Dispatchers.IO) {\n                callMistralAPI(selectedText)\n            }\n\n            if (translation != null) {\n                if (mOriginatingView is EditText && mOriginatingView.isTextEditable) {\n                    mOriginatingView.text.replace(\n                        mOriginatingView.selectionStart,\n                        mOriginatingView.selectionEnd,\n                        translation\n                    )\n                } else {\n                    showResultDialog(context, translation)\n                }\n            }\n        }\n    }\n\n    private fun callMistralAPI(text: String): String? {\n        val json = JSONObject().apply {\n            put(\"model\", \"mistral-small-latest\")\n            put(\"messages\", org.json.JSONArray().apply {\n                put(JSONObject().apply {\n                    put(\"role\", \"system\")\n                    put(\"content\", \"Ты — профессиональный переводчик. Переведи текст на русский язык. Сохраняй смысл и стиль. Выдай ТОЛЬКО перевод.\")\n                })\n                put(JSONObject().apply {\n                    put(\"role\", \"user\")\n                    put(\"content\", text)\n                })\n            })\n        }\n\n        val request = Request.Builder()\n            .url(\"https://api.mistral.ai/v1/chat/completions\")\n            .header(\"Authorization\", \"Bearer $MISTRAL_API_KEY\")\n            .post(json.toString().toRequestBody(\"application/json\".toMediaType()))\n            .build()\n\n        return try {\n            client.newCall(request).execute().use { response ->\n                val body = response.body?.string() ?: return null\n                JSONObject(body).getJSONArray(\"choices\")\n                    .getJSONObject(0).getJSONObject(\"message\")\n                    .getString(\"content\").trim()\n            }\n        } catch (e: Exception) { null }\n    }\n\n    private fun showResultDialog(context: Context, text: String) {\n        AlertDialog.Builder(context)\n            .setTitle(\"AI Перевод\")\n            .setMessage(text)\n            .setPositiveButton(\"OK\", null)\n            .show()\n    }\n}"
}
